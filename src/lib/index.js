(() => {

	// @CONFIGURATIONS:

	const ataquesPokemon = ["a bocajarro","a defender","abatidoras","absorbefuerza","absorber","ácido","acoso","acróbata","acua aro","acua cola","acua jet","acupresión","adaptación","aerochorro","afilagarras","afilar","agarre","agarrón","agilidad","agua lodosa","aguante","aguijón letal","agujero negro aniquilador","aguzar","aire afilado","al ataque","ala de acero","ala mortífera","alarido","alboroto","aligerar","alivio","alud","aluvión de flechas sombrías","amago","amnesia","amortiguador","anclaje","anegar","anillo ígneo","antiaéreo","anticipo","anticura","antojo","anulación","aplastamiento gigalítico","arañazo","aria burbuja","ariete","armadura ácida","aromaterapia","arraigo","arrojo intempestivo","arrumaco","arrumaco sideral","as oculto","ascenso draco","ascuas","asta drenaje","atadura","ataque aéreo","ataque ala","ataque arena","ataque fulgor","ataque furia","ataque óseo","ataque rápido","atizar","atracción","aullido","aura magnética","autodestrucción","auxilio","avalancha","avivar","ayuda","azote","barrena telúrica","barrera","barrera espinosa","batido","beso amoroso","beso drenaje","beso dulce","bilis","bloqueo","bofetón lodo","bola de polen","bola hielo","bola neblina","bola sombra","bola voltio","bomba ácida","bomba fango","bomba germen","bomba huevo","bomba ígnea","bomba imán","bomba lodo","bomba sónica","bostezo","bote","brazo pincho","brecha negra","brillo mágico","buceo","bucle arena","buena baza","búnker","burbuja","cabeza de hierro","cabezazo","cabezazo zen","caída libre","calcinación","camaradería","cambia almas","cambia defensa","cambia fuerza","cambia velocidad","cambio banda","cambio de marcha","camelo","campana cura","campo de hierba","campo de niebla","campo eléctrico","campo psíquico","camuflaje","canon","canto","canto arcaico","canto helado","canto mortal","cañón floral","capa mágica","cara susto","carámbano","carantoña","carga","carga dragón","carga parábola","carga tóxica","carrera arrolladora","cascada","castigo","cede paso","celebración","cerca","cerrojo feérico","cháchara","chapoteo lodo","chirrido","chispa","chispazo","chorro de vapor","chulería","chupavidas","chuzos","ciclón","ciclón de hojas","clavo cañón","clemencia","clonatipo","cola dragón","cola férrea","cola veneno","cólera del guardián","colmillo hielo","colmillo ígneo","colmillo rayo","colmillo veneno","come sueños","cometa draco","concha filo","condena silvana","confidencia","confusión","conjuro","constricción","contoneo","contraataque","conversión","conversión2","coraza trampa","cornada","corpulencia","corte","corte furia","corte vacío","cortina plasma","cosquillas","copión","crioaliento despiadado","cuchillada","cuchilla solar","cuerno certero","cuerpo pesado","cura floral","danza aleteo","danza amiga","danza caos","danza despertar","danza dragón","danza espada","danza llama","danza lluvia","danza lunar","danza pétalo","danza pluma","daño secreto","defensa férrea","defensa floral","demolición","derribo","desarme","desarrollo","descanso","desenrollar","deseo","deseo cura","deseo oculto","deslumbrar","despejar","desquite","destello","destructor","detección","día de pago","día soleado","diluvio corrosivo","disparo demora","disparo espejo","disparo lodo","distorsión","disruptor psíquico","divide dolor","doble ataque","doble bofetón","doble equipo","doble filo","doble golpe","doble patada","doble rayo","don natural","dracoaliento devastador","dragoaliento","drenadoras","dulce aroma","eco metálico","eco voz","electrificación","electrocañón","electropunzada","electrotela","embargo","empujón","encanto","energibola","enfado","enrosque","envite ígneo","eructo","escaldar","escaramuza","escudo real","escudo tatami","escupir","esfera aural","esfuerzo","espabila","espacio raro","espada santa","espora","esporagodón","esquema","estallido","estímulo","estoicismo","estruendo","estrujón","excavar","explosión","falsotortazo","fertilizante","fijar blanco","filo del abismo","finta","fisura","foco","foco energía","foco resplandor","fogonazo","follaje","fortaleza","fragor escamas","frío polar","frustración","fuego fatuo","fuego sagrado","fuerza","fuerza bruta","fuerza equina","fuerza lunar","fuerza telúrica","furia","furia dragón","furia natural","gancho alto","garra brutal","garra dragón","garra metal","garra umbría","gas venenoso","geocontrol","giga impacto","gigadrenado","gigavoltio destructor","giro bola","giro fuego","giro rápido","giro vil","golpe","golpe aéreo","golpe bajo","golpe bis","golpe cabeza","golpe calor","golpe cuerpo","golpe fantasma","golpe kárate","golpe mordaza","golpe roca","golpe umbrío","golpes furia","gran ojo","granizo","gravedad","gruñido","guadaña sedosa","guardia baja","guillotina","halloween","hecatombe pírica","hélice trepanadora","hidroariete","hidrobomba","hidrocañón","hidrochorro","hidropulso","hidrovórtice abisal","hierba lazo","hilo venenoso","hipercolmillo","hiperplancha oscura","hiperrayo","hipnosis","hoja afilada","hoja aguda","hoja mágica","hueso palo","hueso sombrío","huesomerang","humareda","ida y vuelta","imagen","imitación","impactrueno","impresionar","infierno","infortunio","intercambio","inversión","isofuerza","isoguardia","joya de luz","juego sucio","kinético","ladrón","lanza mugre","lanzallamas","lanzamiento","lanzarrocas","latigazo","lariat oscuro","láser prisma","látigo","látigo cepa","látigo ígneo","legado","lengüetazo","levitón","liofilización","llama azul","llama embrujada","llama final","llama fusión","llama gélida","llamarada","llanto falso","llave corsé","llave giro","lluevehojas","lluvia ígnea","luz aniquiladora","luz lunar","machada","magnitud","mal de ojo","maldición","malicioso","mandato","manos juntas","manto espejo","maquinación","martillazo","martillo dragón","martillo hielo","más psique","masa cósmica","mazazo","meditación","megaagotar","megacuerno","megapatada","megapuño","megatón floral","meteoimpacto","meteorobola","metrónomo","mil flechas","mil temblores","mimético","mismo destino","mofa","moflete estático","mordisco","movimiento espejo","movimiento sísmico","multiataque","mundo gélido","neblina","niebla","niebla aromática","niebla clara","nieve polvo","nitrocarga","novena potencia","núcleo castigo","ofrenda","ojitos tiernos","ojos llorosos","onda anómala","onda certera","onda ígnea","onda mental","onda simple","onda tóxica","onda trueno","onda vacío","onda voltio","otra vez","paga extra","pájaro osado","paliza","palmeo","pantalla de luz","pantalla de humo","paralizador","paranormal","paso dimensional","patada baja","patada giro","patada ígnea","patada salto","patada salto alta","patada tropical","pataleta","paz mental","pedrada","perforador","persecución","pesadilla","picado supersónico","picadura","pico cañón","pico taladro","picotazo","picotazo veneno","picoteo","pikavoltio letal","pin misil","piñón auxiliar","pirotecnia","pisotón","pistola agua","placaje","placaje eléctrico","plancha","plancha voladora","planta feroz","plumerazo","poder oculto","poder pasado","poder reserva","polución","polvo explosivo","polvo ira","polvo veneno","premonición","presa","presa espectral","presente","profecía","protección","psicocambio","psicocolmillo","psicocorte","psicoataque","psicocarga","psicoonda","psicorrayo","psíquico","púas","púas tóxicas","pulimento","pulpocañón","pulso cura","pulso dragón","pulso noche","pulso primigenio","pulso umbrío","puntada sombría","puntapié","puño bala","puño certero","puño cometa","puño drenaje","puño fuego","puño hielo","puño incremento","puño mareo","puño meteoro","puño sombra","puño trueno","puño dinámico","purificación","puya nociva","rabia","ráfaga","ráfaga demoledora","rapidez","rastreo","rayo","rayo aurora","rayo burbuja","rayo carga","rayo confuso","rayo fusión","rayo gélido","rayo hielo","rayo solar","rayo umbrío","reciclaje","recogearena","recuperación","recurrente","reducción","red viscosa","reflejo","refuerzo","refugio","relajo","relevo","remolino","rencor","represión metal","represalia","reserva","residuos","respiro","resplandor","restricción","retribución","reversión","rizo algodón","rizo defensa","robo","roca afilada","roca veloz","rodillo de púas","rompecoraza","romperrocas","ronquido","rueda doble","rueda fuego","rugido","rugido de guerra","sable místico","sacrificio","salmuera","salpicadura","salpicar","seducción","sentencia","señuelo","shuriken de agua","silbato","sincrorruido","sinfonía de la diva marina","síntesis","sofoco","sol matinal","sombra vil","somnífero","sonámbulo","sorpresa","sumisión","superdiente","supersónico","surf","surfeo galvánico","sustituto","tajo aéreo","tajo cruzado","tajo umbrío","taladradora","tambor","tecno shock","telaraña","telépata","telequinesis","teletransporte","tenaza","terratemblor","terremoto","testarazo","tierra viva","tijera x","tinieblas","tiro vital","torbellino","tormenta de arena","tormenta de diamantes","tormenta floral","tormento","tornado","tóxico","tragar","trampa rocas","trampa venenosa","transformación","trapicheo","treparrocas","triataque","triple patada","triturar","truco","truco defensa","truco fuerza","trueno","tumba rocas","última baza","última palabra","último lugar","ultrapuño","v de fuego","vaho gélido","vastaguardia","velo aurora","velo sagrado","velocidad extrema","vendaval","vendetta","veneno x","venganza","ventisca","viento aciago","viento afín","viento cortante","viento feérico","viento hielo","viento plata","voltio cruel","voltiocambio","voto agua","voto fuego","voto planta","vozarrón","voz cautivadora","vuelo","yo primero","zona extraña","zona mágica","zumbido"];
	const getAtaquePokemon = function() {
		return ataquesPokemon[Math.floor(Math.random()*ataquesPokemon.length)];
	};

	const configurations = {
		LOCALSTORAGE_STORE: "__EL_LENGUAJE_DE_X__",
		grammarsToRegister: [{
			name: "mylanguage",
			parser: MyLanguageParser
		},{
			name: "mylanguage-reporte",
			parser: {parse:() => {}}
		}],
		grammarForFirstEditor: {
			name: "mylanguage",
			parser: MyLanguageParser
		},
		grammarForSecondEditor: {
			name: "mylanguage-reporte",
			parser: () => true
		},
		clickOnDownload: function() {
			alert("exporting script");
			const searchParams = new URLSearchParams(window.location.search);
			const codigo = editor1.instance.getValue();
			const resultado = getStringOutput(codigo);
			const datos = MyLanguageParser.parse(codigo);
			const listaFenomenos = Object.keys(datos.fenomenos_identificados);
			const codigoReemplazado = codigo
				.replace(/(\{|\}|\>|\:|\@|\(|\)|\[\# *|\])/g,"") // remove strange symbols
				.replace(/([^\n]) +/g, "$1 ") // trim spaces
				.replace(/([A-Za-z0-9ÁÉÍÓÚáéíóú])\-([A-Za-z0-9ÁÉÍÓÚáéíóú])/g, "$1 $2") // space hyphens
				.replace(/(\.\n[ \t\r\n]*)([a-z])]*/g, (match, first, second) => first + second.toUpperCase()) // convert uppercase line-starts
				.replace(/(^[ \t\r\n]*)([a-z])]*/g, (match, first, second) => first + second.toUpperCase()) // convert uppercases first-line
				.replace(/ +\n/g, "\n"); // trim lines
			searchParams.set("code", codigo);
			editor2.instance.setValue(`Hola, querida persona.

¡Una respuesta de scripting salvaje atacó con <${getAtaquePokemon()}>!

Vamos allá.

${codigoReemplazado}

Y hasta aquí la reflexión.

Análisis:
  · Tiempo:     | ${datos.tiempo} segundos
  · Humano:     | ${codigoReemplazado.length} caracteres
  · Código:     | ${codigo.length} caracteres
  · Objeto:     | ${resultado.length} caracteres
  · Símbolos:   | ${datos.sentencias.length} sentencias
  · Fenómenos:  | ${listaFenomenos.length} fenómenos identificados
${listaFenomenos.length ? "    · " + listaFenomenos.join("\n    · ") + "\n" : ""}

Gracias por su atención, aquí tiene el link de la reflexión:

${window.location.protocol}//${window.location.host + window.location.pathname + window.location.hash}?${searchParams.toString()}

`);
		},
		clickOnView: function() {
			console.log("Clicked!");
			const jWrapper = jQuery("body > .wrapper");
			const isHorizontal = jWrapper.hasClass("horizontal-rows");
			if (isHorizontal) {
				jWrapper.removeClass("horizontal-rows");
				jWrapper.addClass("vertical-rows");
			} else {
				jWrapper.removeClass("vertical-rows");
				jWrapper.addClass("horizontal-rows");
			}
		},
		onSuccessFirstEditor: function(output) {
			if (editor2) {
				editor1.clearError();
				const out = getStringOutput(output);
				localStorage[configurations.LOCALSTORAGE_STORE] = editor1.instance.getValue();
				editor2.instance.setValue(out);
			}
		},
		onInitializedFirstEditor: function(editor) {
			console.log("initialized", editor);
			editor1 = editor;
		},
		onInitializedSecondEditor: function(editor) {
			console.log("initialized", editor);
			editor2 = editor;
			if (localStorage[configurations.LOCALSTORAGE_STORE]) {
				const input = localStorage[configurations.LOCALSTORAGE_STORE];
				editor1.instance.setValue(input);
			}
			const urlParams = new URLSearchParams(window.location.search);
			const code = urlParams.get("code");
			if (code) {
				editor1.instance.setValue(code);
			}
		}
	}

	let editor1, editor2;

	// @INITIALIZATION:
	const capitalize = (text) => {
		const index = text.search("[A-Za-z]");
		if (index !== -1) {
			return text.substr(0, index + 1).toUpperCase() + text.substr(index + 1);
		} else {
			return text;
		}
	}

	const getStringOutput = function(output) {
		//console.log(output);
		return JSON.stringify(output, null, 2);
	};

	// Register pegeditor grammars:
	const registerGrammars = () => {
		configurations.grammarsToRegister.forEach(grammar => {
			jQuery.registerPegeditorGrammar(grammar.name, grammar.parser.parse.bind(grammar.parser));
		});
	}

	const createEditors = () => {

		jQuery("#e1").pegeditor({
			options: {
				showLineNumbers: true,
				mode: configurations.grammarForFirstEditor.name
			},
			onSuccess: configurations.onSuccessFirstEditor,
			onInitialized: configurations.onInitializedFirstEditor
		});
		jQuery("#e2").pegeditor({
			options: {
				mode: configurations.grammarForSecondEditor.name
			},
			onInitialized: configurations.onInitializedSecondEditor,
			grammar: () => true
		});
	};

	const addEvents = () => {
		jQuery(".change-download-button").on("click", configurations.clickOnDownload);
		jQuery(".change-view-button").on("click", configurations.clickOnView);
		setTimeout(() => {
			editor1.setCursor(0,0);
			editor1.focus();
		}, 3000);
	}

	const initializeStateFromUrlParameters = () => {

	};

	window.addEventListener("load", () => {
		registerGrammars();
		createEditors();
		addEvents();
	});

})();